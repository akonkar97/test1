name: Gazebo ros2 control CI

on:
  pull_request:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: osrf/ros:galactic-desktop
    steps:
    - uses: actions/checkout@v3
    - name: Setup colcon workspace
      id: configure
      run: |
        cd ..
        mkdir -p ${{github.workspace}}/ros2_ws/src
        cp -r test1 ${{github.workspace}}/ros2_ws/src/
        apt-get update && apt-get upgrade -q -y
        apt-get update && apt-get install -q -y --no-install-recommends \
          dirmngr \
          gnupg2 \
          lsb-release \
          python3-colcon-ros
        cd ${{github.workspace}}/ros2_ws/src/
        rosdep update
        rosdep install --from-paths ./ -i -y --rosdistro galactic \
          --ignore-src
    - name: Build project
      id: build
      run: |
        cd ${{github.workspace}}/ros2_ws/
        . /opt/ros/galactic/local_setup.sh
        colcon build --packages-select test1

    - name: Unit tests
      run: |
        sudo apt install -y lcov
        . /opt/ros/galactic/setup.bash
        colcon config --cmake-args -DCMAKE_CXX_FLAGS="-Wall -Wno-unused --coverage -fno-inline -fno-inline-small-functions -fno-default-inline" -DCMAKE_C_FLAGS="-Wall -Wno-unused --coverage -fno-inline -fno-inline-small-functions -fno-default-inline" -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXE_LINKER_FLAGS="-lgcov"
        colcon build
        
    - name: Configure Codecov
      run: |
        lcov --directory . --capture --output-file coverage.info
        lcov --remove coverage.info '/opt/*' '/usr/*' '*/devel/*' '*_test*' --output-file coverage.info
        lcov --list coverage.info

    - name: Coveralls
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: ${{ github.workspace }}/coverage.info
